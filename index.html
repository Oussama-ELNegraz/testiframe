<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="referrer" content="strict-origin-when-cross-origin" />
<title>Duplecast YT Proxy (Legacy)</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #000;
  }
  #player {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100vw;
    height: 100vh;
  }
</style>

</head>
<body>
<div id="player"></div>

<script>
/* ------------------------------
   ES3-compatible query parser
-------------------------------- */
function getQueryParam(name) {
  var qs = window.location.search.substring(1);
  var parts = qs.split("&");
  for (var i = 0; i < parts.length; i++) {
    var kv = parts[i].split("=");
    if (kv[0] === name) {
      return decodeURIComponent(kv[1]);
    }
  }
  return null;
}

var videoId  = getQueryParam("v") || "M7lc1UVf-VE";
var autoplay = getQueryParam("autoplay") || "1";

var hasUnmuted = false;
var player = null;

/* ------------------------------
   Load YouTube API (ES3 OK)
-------------------------------- */
var tag = document.createElement("script");
tag.src = "https://www.youtube.com/iframe_api";
document.getElementsByTagName("head")[0].appendChild(tag);

/* ------------------------------
   Helper to notify parent app
-------------------------------- */
function notifyParent(state) {
  try {
    window.parent.postMessage(
      { source: "duplecast-yt-proxy", state: state },
      "*"
    );
  } catch (e) {}
}

/* ------------------------------
   Called when API is ready
-------------------------------- */
function onYouTubeIframeAPIReady() {
  player = new YT.Player("player", {
    videoId: videoId,
    host: "https://www.youtube-nocookie.com",

    playerVars: {
      autoplay: autoplay === "1" ? 1 : 0,
      controls: 0,
      rel: 0,
      fs: 1,
      iv_load_policy: 3,
      modestbranding: 1,
      playsinline: 1,
      origin: "https://oussama-elnegraz.github.io", // IMPORTANT: new origin
      mute: 1
    },

    events: {
      "onReady": onPlayerReady,
      "onStateChange": onPlayerStateChange,
      "onError": onPlayerError
    }
  });
}

/* ------------------------------
   Player Ready
-------------------------------- */
function onPlayerReady(event) {
  try {
    event.target.mute();
    event.target.setVolume(0);
    event.target.playVideo();
  } catch (e) {
    // Old browsers = silent fallback
  }
}

/* ------------------------------
   Autoplay → Unmute trick
-------------------------------- */
function onPlayerStateChange(event) {
  // Notify parent that playback started / ended
  if (event.data === YT.PlayerState.PLAYING) {
    notifyParent("PLAYING");
  }
  if (event.data === YT.PlayerState.ENDED) {
    notifyParent("ENDED");
  }

  // Optional auto-unmute trick (can remove if it causes issues)
  if (event.data === YT.PlayerState.PLAYING && !hasUnmuted) {
    hasUnmuted = true;
    setTimeout(function () {
      try {
        player.unMute();
        player.setVolume(100);
      } catch (e) {}
    }, 500);
  }
}

/* ------------------------------
   Error → notify parent
-------------------------------- */
function onPlayerError() {
  notifyParent("ERROR");
}

// Expose callbacks
window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
</script>

</body>
</html>
